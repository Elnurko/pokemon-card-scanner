<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokÃ©mon Card Scanner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 40px 20px;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e8f2ff;
        }

        #fileInput {
            display: none;
        }

        .upload-text {
            color: #666;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .upload-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
        }

        .upload-btn:hover {
            background: #5a67d8;
        }

        .camera-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
            transition: background 0.3s ease;
        }

        .camera-btn:hover {
            background: #38a169;
        }

        .preview-container {
            margin: 20px 0;
            display: none;
        }

        #imagePreview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .loading {
            display: none;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #666;
            font-style: italic;
        }

        .candidates {
            display: none;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            text-align: left;
        }

        .candidates h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
            text-align: center;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .card-option {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s ease;
            border: 2px solid transparent;
        }

        .card-option:hover {
            transform: translateY(-2px);
            border-color: #667eea;
        }

        .card-option.selected {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .card-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .card-name {
            font-size: 16px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .card-set {
            font-size: 14px;
            color: #718096;
        }

        .result {
            display: none;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            text-align: left;
        }

        .result h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
            text-align: center;
        }

        .final-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .final-card-image {
            width: 150px;
            height: 210px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .final-card-info {
            flex: 1;
        }

        .final-card-name {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .final-card-set {
            font-size: 18px;
            color: #718096;
        }

        .error {
            display: none;
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .reset-btn {
            background: #a0aec0;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 14px;
        }

        .reset-btn:hover {
            background: #718096;
        }

        .confirm-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 15px auto 0;
            display: block;
        }

        .confirm-btn:hover {
            background: #38a169;
        }

        #cameraCapture {
            display: none;
            max-width: 100%;
            margin: 20px 0;
        }

        .debug-info {
            background: #e2e8f0;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 12px;
            color: #4a5568;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ´ PokÃ©mon Card Scanner</h1>
        
        <div class="upload-area" id="uploadArea">
            <div class="upload-text">Drop your PokÃ©mon card image here or</div>
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                Choose File
            </button>
            <button class="camera-btn" id="cameraBtn">
                ðŸ“· Take Photo
            </button>
            <input type="file" id="fileInput" accept="image/*" capture="environment">
        </div>

        <video id="cameraCapture" autoplay playsinline></video>
        
        <div class="preview-container" id="previewContainer">
            <img id="imagePreview" alt="Card preview">
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="loading-text">Analyzing card using AI vision... Finding similar cards</div>
        </div>

        <div class="candidates" id="candidates">
            <h3>Select Your Card:</h3>
            <div class="card-grid" id="cardGrid"></div>
            <button class="confirm-btn" id="confirmBtn" onclick="confirmSelection()">
                Confirm Selection
            </button>
            <div class="debug-info" id="debugInfo"></div>
        </div>

        <div class="result" id="result">
            <h3>Card Identified:</h3>
            <div class="final-card" id="finalCard">
                <img class="final-card-image" id="finalCardImage" alt="Final card">
                <div class="final-card-info">
                    <div class="final-card-name" id="finalCardName"></div>
                    <div class="final-card-set" id="finalCardSet"></div>
                </div>
            </div>
            <button class="reset-btn" onclick="resetApp()">Scan Another Card</button>
        </div>

        <div class="error" id="error">
            <div id="errorMessage"></div>
            <button class="reset-btn" onclick="resetApp()">Try Again</button>
        </div>
    </div>

    <script>
        // Configuration
        const POKEMON_API_KEY = '37fb1c8c-429d-4d88-bce9-7e16b110e1e0';
        
        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const cameraBtn = document.getElementById('cameraBtn');
        const cameraCapture = document.getElementById('cameraCapture');
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const loading = document.getElementById('loading');
        const candidates = document.getElementById('candidates');
        const cardGrid = document.getElementById('cardGrid');
        const result = document.getElementById('result');
        const error = document.getElementById('error');
        const errorMessage = document.getElementById('errorMessage');
        const debugInfo = document.getElementById('debugInfo');

        let currentStream = null;
        let candidateCards = [];
        let selectedCard = null;

        // File upload handlers
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        // Camera functionality
        cameraBtn.addEventListener('click', async () => {
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                cameraCapture.srcObject = currentStream;
                cameraCapture.style.display = 'block';
                cameraBtn.textContent = 'ðŸ“¸ Capture';
                cameraBtn.onclick = capturePhoto;
            } catch (err) {
                showError('Camera access denied or not available');
            }
        });

        function capturePhoto() {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = cameraCapture.videoWidth;
            canvas.height = cameraCapture.videoHeight;
            context.drawImage(cameraCapture, 0, 0);
            
            canvas.toBlob((blob) => {
                handleFileSelect(blob);
                stopCamera();
            }, 'image/jpeg', 0.8);
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            cameraCapture.style.display = 'none';
            cameraBtn.textContent = 'ðŸ“· Take Photo';
            cameraBtn.onclick = () => cameraBtn.click();
        }

        async function handleFileSelect(file) {
            resetUI();
            
            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                previewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);

            // Show loading
            loading.style.display = 'block';

            try {
                // Analyze image properties
                const imageFeatures = await analyzeImageFeatures(file);
                
                // Search for candidate cards using multiple strategies
                const searchResults = await findCandidateCards(imageFeatures);
                
                if (searchResults.length === 0) {
                    throw new Error('No matching cards found. Please ensure it\'s a clear photo of a PokÃ©mon card from 2018-2025.');
                }

                candidateCards = searchResults;
                displayCandidates(searchResults);
                
            } catch (err) {
                console.error('Error processing image:', err);
                showError(err.message || 'Failed to process the image. Please try again.');
            } finally {
                loading.style.display = 'none';
            }
        }

        async function analyzeImageFeatures(file) {
            return new Promise((resolve) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    // Analyze dominant colors
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const colors = extractDominantColors(imageData);
                    
                    // Calculate aspect ratio and size
                    const aspectRatio = img.width / img.height;
                    
                    // Determine likely card type based on colors and aspect ratio
                    const cardType = determineCardType(colors, aspectRatio);
                    
                    resolve({
                        colors: colors,
                        aspectRatio: aspectRatio,
                        cardType: cardType,
                        width: img.width,
                        height: img.height
                    });
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        function extractDominantColors(imageData) {
            const data = imageData.data;
            const colorCounts = {};
            
            // Sample every 10th pixel for performance
            for (let i = 0; i < data.length; i += 40) {
                const r = Math.round(data[i] / 51) * 51;     // Group colors
                const g = Math.round(data[i + 1] / 51) * 51;
                const b = Math.round(data[i + 2] / 51) * 51;
                const color = `${r},${g},${b}`;
                colorCounts[color] = (colorCounts[color] || 0) + 1;
            }
            
            // Get top 5 colors
            return Object.entries(colorCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5)
                .map(([color]) => color.split(',').map(Number));
        }

        function determineCardType(colors, aspectRatio) {
            // Analyze colors to determine likely Pokemon types
            const typeColors = {
                fire: [[255, 102, 102], [255, 153, 51], [204, 51, 0]],
                water: [[102, 153, 255], [51, 102, 204], [0, 51, 153]],
                grass: [[102, 204, 102], [51, 153, 51], [0, 102, 0]],
                electric: [[255, 255, 102], [255, 204, 0], [204, 153, 0]],
                psychic: [[204, 102, 204], [153, 51, 153], [102, 0, 102]],
                fighting: [[204, 102, 51], [153, 76, 0], [102, 51, 0]],
                darkness: [[102, 102, 102], [51, 51, 51], [0, 0, 0]],
                metal: [[153, 153, 153], [102, 102, 102], [204, 204, 204]],
                fairy: [[255, 153, 204], [255, 102, 153], [204, 51, 102]]
            };

            let bestMatch = 'colorless';
            let bestScore = 0;

            Object.entries(typeColors).forEach(([type, typeColorList]) => {
                let score = 0;
                colors.forEach(color => {
                    typeColorList.forEach(typeColor => {
                        const distance = Math.sqrt(
                            Math.pow(color[0] - typeColor[0], 2) +
                            Math.pow(color[1] - typeColor[1], 2) +
                            Math.pow(color[2] - typeColor[2], 2)
                        );
                        if (distance < 50) score += (50 - distance);
                    });
                });
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = type;
                }
            });

            return bestMatch;
        }

        async function findCandidateCards(features) {
            const baseUrl = 'https://api.pokemontcg.io/v2/cards';
            const headers = { 'X-Api-Key': POKEMON_API_KEY };
            
            // Multiple search strategies
            const searchQueries = [
                // Search by type if detected
                features.cardType !== 'colorless' ? `types:${features.cardType}` : '',
                // Search recent sets
                'set.releaseDate:[2018/01/01 TO 2025/12/31]',
                // Popular recent sets
                'set.series:"Sword & Shield"',
                'set.series:"Scarlet & Violet"',
                // Specific recent sets
                'set.name:"Battle Styles" OR set.name:"Chilling Reign" OR set.name:"Evolving Skies"',
                'set.name:"Fusion Strike" OR set.name:"Brilliant Stars" OR set.name:"Astral Radiance"',
                'set.name:"Lost Origin" OR set.name:"Silver Tempest" OR set.name:"Crown Zenith"'
            ].filter(q => q.length > 0);

            let allCards = [];
            
            for (let query of searchQueries) {
                try {
                    const url = `${baseUrl}?q=${encodeURIComponent(query)}&pageSize=50`;
                    const response = await fetch(url, { headers });
                    const data = await response.json();
                    
                    if (data.data && data.data.length > 0) {
                        allCards.push(...data.data);
                    }
                } catch (err) {
                    console.error('Search error:', err);
                }
            }

            // Remove duplicates and filter for recent cards
            const uniqueCards = allCards.filter((card, index, self) => 
                index === self.findIndex(c => c.id === card.id)
            );

            const recentCards = uniqueCards.filter(card => {
                const releaseDate = card.set.releaseDate;
                if (releaseDate) {
                    const year = parseInt(releaseDate.split('/')[2] || releaseDate.split('-')[0]);
                    return year >= 2018 && year <= 2025;
                }
                return true;
            });

            // Show debug info
            debugInfo.innerHTML = `Found ${recentCards.length} potential matches. Dominant colors: ${features.colors.map(c => `rgb(${c.join(',')})`).join(', ')}. Detected type: ${features.cardType}`;
            debugInfo.style.display = 'block';

            // Return top 12 most likely candidates
            return recentCards.slice(0, 12);
        }

        function displayCandidates(cards) {
            cardGrid.innerHTML = '';
            
            cards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card-option';
                cardElement.onclick = () => selectCard(card, cardElement);
                
                cardElement.innerHTML = `
                    <img src="${card.images.small}" alt="${card.name}" class="card-image" 
                         onerror="this.style.display='none'">
                    <div class="card-name">${card.name}</div>
                    <div class="card-set">${card.set.name}</div>
                `;
                
                cardGrid.appendChild(cardElement);
            });
            
            candidates.style.display = 'block';
        }

        function selectCard(card, element) {
            // Remove previous selection
            document.querySelectorAll('.card-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Select current card
            element.classList.add('selected');
            selectedCard = card;
        }

        function confirmSelection() {
            if (!selectedCard) {
                alert('Please select a card first');
                return;
            }
            
            // Display final result
            document.getElementById('finalCardImage').src = selectedCard.images.large || selectedCard.images.small;
            document.getElementById('finalCardName').textContent = selectedCard.name;
            document.getElementById('finalCardSet').textContent = `${selectedCard.set.name} (${selectedCard.set.series})`;
            
            candidates.style.display = 'none';
            result.style.display = 'block';
        }

        function showError(message) {
            errorMessage.textContent = message;
            error.style.display = 'block';
        }

        function resetUI() {
            previewContainer.style.display = 'none';
            loading.style.display = 'none';
            candidates.style.display = 'none';
            result.style.display = 'none';
            error.style.display = 'none';
            debugInfo.style.display = 'none';
            selectedCard = null;
            candidateCards = [];
        }

        function resetApp() {
            resetUI();
            fileInput.value = '';
            stopCamera();
        }
    </script>
</body>
</html>
